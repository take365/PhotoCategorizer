<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>属性検索</title>
  <style>
    :root {
      color-scheme: light dark;
      font-family: "Segoe UI", "Hiragino Sans", system-ui;
      background: #f4f5f7;
      color: #1e1f21;
    }
    body { margin: 0; padding: 0; }
    main { max-width: none; width: 100%; margin: 0; padding: 24px 32px; box-sizing: border-box; }
    h1 { margin-bottom: 1.2rem; }
    .layout { display: grid; grid-template-columns: minmax(280px, 340px) minmax(0, 1fr); gap: 24px; align-items: start; }
    @media (max-width: 960px) {
      .layout { grid-template-columns: 1fr; }
      form.search-panel { position: static; }
    }
    form.search-panel { background: #fff; border-radius: 12px; padding: 18px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; gap: 16px; position: sticky; top: 24px; }
    label { display: block; font-weight: 600; margin-bottom: 4px; }
    input[type="text"], textarea { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #cbd2d9; font-size: 14px; box-sizing: border-box; }
    textarea { min-height: 60px; }
    details { background: #f5f7fa; border-radius: 10px; padding: 10px 12px; }
    details summary { cursor: pointer; font-weight: 600; }
    .attr-block { margin-top: 12px; display: grid; grid-template-columns: 1fr; gap: 12px; }
    .attr-field { background: #fff; border-radius: 10px; padding: 12px; border: 1px solid #e3e7eb; }
    .attr-field h3 { margin: 0 0 8px; font-size: 15px; }
    .weight-row { display: flex; align-items: center; gap: 12px; margin-top: 8px; font-size: 13px; }
    input[type="range"] { width: 100%; }
    .weight-value { min-width: 40px; text-align: right; font-variant-numeric: tabular-nums; }
    .image-upload { background: #fff; border-radius: 10px; padding: 12px; border: 1px solid #e3e7eb; display: flex; flex-direction: column; gap: 8px; }
    button.primary { padding: 10px 16px; font-size: 15px; font-weight: 600; color: #fff; background: #0055ff; border: none; border-radius: 8px; cursor: pointer; }
    button.primary:hover { background: #1e6bff; }
    .results-panel { display: flex; flex-direction: column; gap: 24px; }
    .status { font-size: 13px; color: #4b5563; }
    .message { padding: 12px; border-radius: 8px; background: #fff4e5; color: #7a3917; border: 1px solid #f3c99b; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 18px; }
    .card { background: #fff; border-radius: 12px; padding: 14px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); display: flex; flex-direction: column; gap: 12px; position: relative; }
    .card img { width: 100%; border-radius: 10px; }
    .card h3 { margin: 0; font-size: 15px; display: flex; justify-content: space-between; align-items: baseline; }
    .card h3 span.score { font-size: 13px; color: #4b5563; }
    .detail-button { background: #2563eb; color: #fff; border: none; border-radius: 8px; padding: 8px 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .detail-button:hover { background: #1e40af; }
    pre { background: #111827; color: #e5e7eb; padding: 12px; border-radius: 8px; font-size: 13px; overflow: auto; }
    .contrib { display: flex; flex-direction: column; gap: 6px; font-size: 13px; }
    .contrib-bar { height: 10px; background: linear-gradient(90deg, #4f46e5, #22d3ee); border-radius: 6px; }
    .quick-actions { display: flex; flex-direction: column; gap: 8px; margin-top: 4px; }
    .quick-actions form { width: 100%; }
    .quick-actions button { width: 100%; background: #f3f4f6; border: 1px solid #d1d5db; border-radius: 8px; padding: 8px 12px; cursor: pointer; font-weight: 600; font-size: 13px; }
    .quick-actions button:hover { background: #e5e7eb; }
    .detail-overlay { position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 2000; }
    .detail-overlay::before { content: ""; position: absolute; inset: 0; background: rgba(15, 23, 42, 0.55); }
    .detail-card { position: relative; display: flex; flex-direction: row; gap: 16px; width: min(90vw, 1100px); max-height: 90vh; background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 20px 40px rgba(15, 23, 42, 0.35); z-index: 2001; }
    .detail-image-wrapper { flex: 0 0 55%; display: flex; flex-direction: column; align-items: center; gap: 12px; }
    .detail-image-wrapper img { width: 100%; height: auto; max-height: 70vh; object-fit: contain; border-radius: 12px; background: #0f172a; }
    .detail-info { flex: 1 1 auto; display: flex; flex-direction: column; gap: 16px; min-width: 0; }
    .detail-info h2 { margin: 0; font-size: 18px; }
    .detail-info p { margin: 0; font-size: 13px; color: #475569; word-break: break-all; }
    .detail-fields { display: grid; gap: 12px; }
    .detail-field h3 { margin: 0 0 4px; font-size: 15px; color: #1f2933; }
    .detail-field p { margin: 0; font-size: 15px; line-height: 1.6; color: #111827; white-space: pre-wrap; }
    .detail-meta { display: grid; gap: 8px; font-size: 13px; color: #475569; }
    #attr-detail-contrib { font-size: 13px; color: #111827; }
    #attr-detail-contrib .contrib-bar { margin-top: 4px; }
    .detail-close { position: absolute; top: 12px; right: 12px; background: transparent; border: none; font-size: 24px; line-height: 1; color: #334155; cursor: pointer; }
    .detail-close:hover { color: #0f172a; }
    body.modal-open { overflow: hidden; }
  </style>
</head>
<body>
  <header style="background:#0f172a; color:#f8fafc; padding:12px 24px;">
    <nav style="display:flex; gap:16px;">
      <a href="/" style="color:#fff; font-weight:600; text-decoration:none; border-bottom:2px solid #38bdf8; padding-bottom:2px;">属性検索</a>
      <a href="/scatter" style="color:rgba(248,250,252,0.85); font-weight:600; text-decoration:none;">意味軸マップ</a>
      <a href="/clusters" style="color:rgba(248,250,252,0.85); font-weight:600; text-decoration:none;">クラスタマップ</a>
    </nav>
  </header>
  <main>
    <h1>属性検索</h1>
    <div class="layout">
      <form class="search-panel" action="/search" method="post" enctype="multipart/form-data">
        <input type="hidden" name="mode" value="search" />
        <div>
          <label for="general_query">キーワード</label>
          <input type="text" id="general_query" name="general_query" value="{{ form_values.general_query }}" placeholder="例: 夕焼けのビーチで遊ぶ子ども" />
        </div>
        <details>
          <summary>詳細条件</summary>
          <div class="attr-block">
            {% for key, label in attr_labels.items() %}
            <div class="attr-field">
              <h3>{{ label }}</h3>
              <input type="text" name="{{ key }}_query" value="{{ form_values.attr_queries[key] }}" placeholder="{{ label }} のテキスト" />
              <div class="weight-row">
                <span>重み</span>
                <input type="range" name="{{ key }}_weight" min="0" max="100" step="5" value="{{ form_values.attr_weights[key] }}" />
                <span class="weight-value">{{ '%0.2f'|format(form_values.attr_weights[key] / 100) }}</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </details>
        <div class="image-upload">
          <label for="image_file">画像から検索</label>
          <input type="file" id="image_file" name="image_file" accept="image/*" />
          <div class="weight-row">
            <span>画像重み</span>
            <input type="range" name="image_weight" min="0" max="100" step="5" value="{{ form_values.image_weight }}" />
            <span class="weight-value">{{ '%0.2f'|format(form_values.image_weight / 100) }}</span>
          </div>
        </div>
        <div>
          <label for="top_k">取得件数</label>
          <input type="number" id="top_k" name="top_k" value="{{ form_values.top_k }}" min="1" max="200" />
        </div>
        <button type="submit" class="primary">検索する</button>
      </form>

      <section class="results-panel">
        {% if message %}
          <div class="message">{{ message }}</div>
        {% endif %}
        {% if elapsed %}
          <div class="status">検索時間: {{ '%.2f'|format(elapsed) }} 秒 / 件数: {{ results|length }}</div>
        {% endif %}
        {% if not results %}
          <div class="status">検索結果がありません。条件と重みを調整してください。</div>
        {% else %}
          <div class="cards">
            {% for item in results %}
            <div class="card">
              <img src="data:image/jpeg;base64,{{ item.thumb }}" alt="thumb" />
              <h3>
                <span>ID: {{ item.image_id }}</span>
                <span class="score">score {{ '%.3f'|format(item.score) }}</span>
              </h3>
              <p style="margin:0; font-size:13px; color:#4b5563;">{{ item.image_path }}</p>
              <button type="button"
                class="detail-button"
                data-image="data:image/jpeg;base64,{{ item.full }}"
                data-path="{{ item.image_path }}"
                data-attrs='{{ item.attributes | tojson | safe }}'
                data-contrib='{{ item.contributions | tojson | safe }}'
              >詳細を表示</button>
              <div class="quick-actions">
                <form action="/search" method="post">
                  <input type="hidden" name="mode" value="from_image" />
                  <input type="hidden" name="ref_image_id" value="{{ item.image_id }}" />
                  <button type="submit">画像類似検索</button>
                </form>
                {% for key, label in attr_labels.items() %}
                <form action="/search" method="post">
                  <input type="hidden" name="mode" value="from_attr" />
                  <input type="hidden" name="ref_image_id" value="{{ item.image_id }}" />
                  <input type="hidden" name="ref_attr_key" value="{{ key }}" />
                  <button type="submit">{{ label }}類似</button>
                </form>
                {% endfor %}
              </div>
            </div>
            {% endfor %}
          </div>
        {% endif %}
      </section>
    </div>
  </main>

  <div id="attr-detail-overlay" class="detail-overlay" style="display:none;">
    <div class="detail-card">
      <button type="button" class="detail-close" id="attr-detail-close">×</button>
      <div class="detail-image-wrapper">
        <img id="attr-detail-image" src="" alt="detail" />
      </div>
      <div class="detail-info">
        <h2>選択中の結果</h2>
        <p id="attr-detail-path"></p>
        <div class="detail-fields">
          <div class="detail-field">
            <h3>ロケーション</h3>
            <p id="attr-detail-location">(未設定)</p>
          </div>
          <div class="detail-field">
            <h3>被写体</h3>
            <p id="attr-detail-subject">(未設定)</p>
          </div>
        </div>
        <div class="detail-meta" id="attr-detail-meta"></div>
        <div class="contrib" id="attr-detail-contrib"></div>
      </div>
    </div>
  </div>

  <script>
    const detailOverlay = document.getElementById('attr-detail-overlay');
    const detailClose = document.getElementById('attr-detail-close');
    const detailImage = document.getElementById('attr-detail-image');
    const detailPath = document.getElementById('attr-detail-path');
    const detailLocation = document.getElementById('attr-detail-location');
    const detailSubject = document.getElementById('attr-detail-subject');
    const detailMeta = document.getElementById('attr-detail-meta');
    const detailContrib = document.getElementById('attr-detail-contrib');

    function formatContributions(contrib) {
      if (!Array.isArray(contrib) || !contrib.length) {
        return '<p style="margin:0; font-size:13px; color:#475569;">類似度内訳はありません。</p>';
      }
      return contrib.map(item => {
        const label = item.label || item.key;
        const value = typeof item.value === 'number' ? item.value.toFixed(3) : item.value;
        const percent = typeof item.percent === 'number' ? item.percent.toFixed(1) : item.percent;
        return `
          <div style="margin-bottom:8px;">
            <div>${label}: ${value} (${percent}%)</div>
            <div class="contrib-bar" style="width:${percent}%;"></div>
          </div>
        `;
      }).join('');
    }

    function openDetailModal(imageSrc, path, attrs, contrib) {
      detailImage.src = imageSrc || '';
      detailPath.textContent = path || '';
      const locationText = attrs && attrs.location ? attrs.location : '(未設定)';
      const subjectText = attrs && attrs.subject ? attrs.subject : '(未設定)';
      detailLocation.textContent = locationText;
      detailSubject.textContent = subjectText;

      const metaKeys = [
        { key: 'tone', label: 'トーン' },
        { key: 'style', label: 'スタイル' },
        { key: 'composition', label: '構図' },
      ];
      const filledMeta = metaKeys
        .map(({ key, label }) => ({ label, value: attrs && attrs[key] ? attrs[key] : '' }))
        .filter(item => item.value && item.value.trim() !== '');
      if (filledMeta.length) {
        detailMeta.innerHTML = filledMeta
          .map(item => `<div><strong>${item.label}</strong>：${item.value}</div>`)
          .join('');
      } else {
        detailMeta.innerHTML = '';
      }
      detailContrib.innerHTML = formatContributions(contrib);
      detailOverlay.style.display = 'flex';
      document.body.classList.add('modal-open');
    }

    function closeDetailModal() {
      detailOverlay.style.display = 'none';
      document.body.classList.remove('modal-open');
    }

    detailClose.addEventListener('click', closeDetailModal);
    detailOverlay.addEventListener('click', (event) => {
      if (event.target === detailOverlay) {
        closeDetailModal();
      }
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && detailOverlay.style.display === 'flex') {
        closeDetailModal();
      }
    });

    document.querySelectorAll('.detail-button').forEach(button => {
      button.addEventListener('click', () => {
        try {
          const imageSrc = button.dataset.image || '';
          const path = button.dataset.path || '';
          const attrs = JSON.parse(button.dataset.attrs || '{}');
          const contrib = JSON.parse(button.dataset.contrib || '[]');
          openDetailModal(imageSrc, path, attrs, contrib);
        } catch (error) {
          console.error('Failed to open detail modal', error);
        }
      });
    });
  </script>
</body>
</html>
