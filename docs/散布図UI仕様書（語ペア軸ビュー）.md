# 散布図UI仕様書（語ペア軸ビュー）

## 目的

* 画像埋め込みベクトル（OpenCLIP）を散布図として可視化する。
* 任意の語ペア（対義語）をX軸・Y軸に設定し、意味に基づいた座標配置を行う。
* 極小サムネイルを点として表示し、ホバーやクリックで詳細を確認できるようにする。
* 既存の検索画面と行き来できるよう、メニューに本画面を追加する。

## 概要

* ユーザー自身が X/Y 軸の「プラス側語」「マイナス側語」を自由に入力し、語群の平均ベクトルを軸として投影する。
* 散布図は 2D で表示され、各点はサムネイル画像。ズーム・ドラッグ・ホバーで確認できる。
* 詳細オーバーレイでは拡大画像と Qwen から抽出した属性テキストを表示し、簡易アクションを提供する。

## 画面要素

### 入力エリア

* **軸キー**: location / subject / tone / style / composition から選択。
* **語群入力**: それぞれの軸でプラス側・マイナス側語を改行区切りで入力。
  * UI では英語語彙と日本語メモを併記できるテキストエリアを用意。
  * 自動補完機能はなし。ユーザーが任意の語を記述する。
* **表示件数スライダー**: 10～1000 枚の範囲で調整。
* **スケーリング選択**: robust / none を選択可能。
* **リセットボタン**: ズーム状態を初期化。

### 散布図エリア

* サムネイル（20〜96px）を点として表示し、ズーム量に応じてサイズを調整。
* ジッターを付与して重なりを軽減。ズーム／ドラッグはスクロール・ドラッグ操作で行う。
* ホバー: カーソル位置のツールチップにクラスタIDや属性概要を表示。
* クリック: 詳細オーバーレイを開き、画像原寸 + 抽出属性（location/subject/tone/style/composition）を表示。
* 投影ロジック:
  * `x = ⟨e_i, x_axis⟩`, `y = ⟨e_i, y_axis⟩`
  * scaling が robust の場合は中央値と IQR でスケール。
  * y 軸は Gram-Schmidt で x 軸に直交化。

### 詳細オーバーレイ

* 拡大画像／ファイルパスの表示。
* location / subject を自然文のまま表示。
* tone / style / composition を日本語ラベルでリスト表示。
* 将来的なアクション（類似検索など）はモーダル内ボタンで拡張可能。

### メニュー

* 既存の検索画面に加えて、**「散布図（語ペア）」メニュー**を追加。
* ユーザーが検索画面と散布図画面を切り替えられるようにする。

## バックエンド仕様

* **反対語補完**: 実装なし（利用者が手入力）。
* **軸ベクトル作成**:
  * 各語群をテキスト埋め込み（Sarashina 等）→平均。
  * 差分を正規化して軸方向とし、y 軸は Gram-Schmidt で直交化。
* **投影**: 画像ごとの属性埋め込み（location/subject 等）と軸との内積。
* **重み付け**: |x|+|y| を降順ソートし、limit 件を返却。

## API例

### 軸補完

```
POST /scatter/project
{
  "axis_x": {
    "key": "location",
    "positives": ["outdoor", "landscape"],
    "negatives": ["indoor", "room"]
  },
  "axis_y": {
    "key": "subject",
    "positives": ["people"],
    "negatives": ["objects"]
  },
  "limit": 120,
  "scaling": "robust"
}
```

返却: 各画像の id / x / y / raw_x / raw_y / magnitude / サムネイル / 属性JSON / パス。
